!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).GLea=e()}(this,(function(){"use strict";function t(t,e){return{shaderType:e,init:r=>{const n=/frag/.test(e)?WebGLRenderingContext.FRAGMENT_SHADER:WebGLRenderingContext.VERTEX_SHADER,i=r.createShader(n);if(!i)throw Error("shader type not supported");if(r.shaderSource(i,t),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS))throw"Could not compile Shader.\n\n"+r.getShaderInfoLog(i);return i}}}class e{constructor({canvas:t,gl:e,contextType:r="webgl",shaders:n,buffers:i,devicePixelRatio:o=1,glOptions:a}){if(this.canvas=document.createElement("canvas"),this.canvas=t||document.querySelector("canvas"),this.canvas||(this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas)),!document.querySelector("link[rel=stylesheet], style")){const t=document.createElement("style");t.innerHTML="body{margin:0}canvas{display:block;width:100vw;height:100vh}",document.head.appendChild(t)}this.contextType=r,this.glOptions=a,this.gl=e||this.getContext(r,a);const s=this.gl.createProgram();this.program=s,this.buffers={},this.shaderFactory=n,this.bufferFactory=i||this.getDefaultBuffers(),this.textures=[],this.devicePixelRatio=o}getDefaultBuffers(){return{position:e.buffer(2,[1,1,-1,1,1,-1,-1,-1])}}getContext(t,e){if("webgl"===t)return this.canvas.getContext("webgl",e)||this.canvas.getContext("experimental-webgl",e);if("webgl2"===t)return this.canvas.getContext("webgl2",e);throw Error(`no ${t} context available.`)}static vertexShader(e="precision highp float;attribute vec2 position;void main(){gl_Position=vec4(position,0, 1.);}"){return t(e,"vert")}static fragmentShader(e="precision highp float;precision highp float;void main(){gl_FragColor = vec4(1.,0.,0.,1.);}"){return t(e,"frag")}prog(t,e,r){const n=t.createProgram(),i=e.init(t),o=r.init(t);if(t.attachShader(n,i),t.attachShader(n,o),t.linkProgram(n),t.validateProgram(n),!t.getProgramParameter(n,t.LINK_STATUS)){throw"Could not compile WebGL program. \n\n"+t.getProgramInfoLog(n)}return n}static buffer(t,e,r=WebGLRenderingContext.STATIC_DRAW,n=WebGLRenderingContext.FLOAT,i=!1,o=0,a=0){return(s,h,c)=>{const u=h.getAttribLocation(c,s);h.enableVertexAttribArray(u);const f=h.createBuffer(),g=e instanceof Array?function(t,e=WebGLRenderingContext.FLOAT){if(e===WebGLRenderingContext.FLOAT)return new Float32Array(t);if(e===WebGLRenderingContext.BYTE)return new Uint8Array(t);throw Error("type not supported")}(e,n):e;return h.bindBuffer(h.ARRAY_BUFFER,f),h.bufferData(h.ARRAY_BUFFER,g,r),h.vertexAttribPointer(u,t,n,i,o,a),{id:f,name:s,data:g,loc:u,type:n,size:t}}}create(){const{gl:t}=this;return this.program=this.prog(t,this.shaderFactory[0],this.shaderFactory[1]),this.use(),Object.keys(this.bufferFactory).forEach(e=>{const r=this.bufferFactory[e];this.buffers[e]=r(e,t,this.program)}),this.parent||this.resize(),this}replaceCanvas(){const{canvas:t}=this,e=t.cloneNode();t.parentNode&&(t.parentNode.insertBefore(e,t),t.parentNode.removeChild(t)),this.canvas=e}restart(){return this.replaceCanvas(),this.gl=this.getContext(this.contextType,this.glOptions),this.create(),this}add({shaders:t,buffers:r}){const n=new e({canvas:this.canvas,gl:this.gl,shaders:t,buffers:r||this.getDefaultBuffers()});return n.parent=this.parent||this,n.create(),n}setActiveTexture(t,e){const{gl:r}=this;r.activeTexture(r.TEXTURE0+t),r.bindTexture(r.TEXTURE_2D,e)}createTexture(t=0,e={textureWrapS:"clampToEdge",textureWrapT:"clampToEdge",textureMinFilter:"nearest",textureMagFilter:"nearest"}){const r=(t="")=>/^[A-Z0-9_]+$/.test(t)?t:t.replace(/([A-Z])/g,"_$1").toUpperCase(),{gl:n}=this,i=n.createTexture();n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,i);for(let t in e)if(e.hasOwnProperty(t)){const i=r(t),o=r(e[t]);i in n&&o in n&&n.texParameteri(n.TEXTURE_2D,n[i],n[o])}return this.textures.push(i),i}updateBuffer(t,e=0){const{gl:r}=this,n=this.buffers[t];r.bindBuffer(r.ARRAY_BUFFER,n.id),r.bufferSubData(r.ARRAY_BUFFER,e,n.data)}resize(){const{canvas:t,gl:e,devicePixelRatio:r}=this;t&&(t.width=t.clientWidth*r,t.height=t.clientHeight*r,e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight))}get width(){return this.canvas?this.canvas.width:NaN}get height(){return this.canvas?this.canvas.height:NaN}use(t){return t&&(this.program=t),this.gl.useProgram(this.program),this}uniM(t,e){const{gl:r,program:n}=this,i=r.getUniformLocation(n,t);if(4===e.length)return r.uniformMatrix2fv(i,!1,e),i;if(9===e.length)return r.uniformMatrix3fv(i,!1,e),i;if(16===e.length)return r.uniformMatrix4fv(i,!1,e),i;throw Error("unsupported uniform matrix type")}uniV(t,e){const{gl:r,program:n}=this,i=r.getUniformLocation(n,t);if(2===e.length)return r.uniform2fv(i,e),i;if(3===e.length)return r.uniform3fv(i,e),i;if(4===e.length)return r.uniform4fv(i,e),i;throw Error("unsupported uniform vector type")}uniIV(t,e){const{gl:r,program:n}=this,i=r.getUniformLocation(n,t);if(2===e.length)return r.uniform2iv(i,e),i;if(3===e.length)return r.uniform3iv(i,e),i;if(4===e.length)return r.uniform4iv(i,e),i;throw Error("unsupported uniform vector type")}uni(t,e){const{gl:r,program:n}=this,i=r.getUniformLocation(n,t);return"number"==typeof e&&r.uniform1f(i,e),i}uniI(t,e){const{gl:r,program:n}=this,i=r.getUniformLocation(n,t);"number"==typeof e&&r.uniform1i(i,e)}clear(t=null){const{gl:e}=this;t&&e.clearColor(t[0],t[1],t[2],1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}destroy(){const{gl:t,program:e}=this;try{t.deleteProgram(e),Object.values(this.buffers).forEach(e=>{t.deleteBuffer(e.id)}),this.buffers={},this.textures.forEach(e=>{t.deleteTexture(e)}),this.textures=[],t.getExtension("WEBGL_lose_context").loseContext(),this.replaceCanvas()}catch(t){console.error(t)}}}return e}));
